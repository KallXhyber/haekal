<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title id="seo-title">Profil BioLink Anda</title>
    <meta id="seo-description" name="description" content="Semua link saya di satu tempat.">
    <link id="favicon" rel="icon" href="https://placehold.co/32x32/007bff/ffffff?text=B">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sans': ['var(--font-family)', 'ui-sans-serif', 'system-ui'] },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 1s cubic-bezier(.36,.07,.19,.97) both infinite',
                        'bounce-fast': 'bounce 0.8s infinite',
                        'highlight-glow': 'highlight-glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        'highlight-glow': { 'from': { 'box-shadow': '0 0 5px 0px var(--highlight-color)' }, 'to': { 'box-shadow': '0 0 20px 8px var(--highlight-color)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            --primary-color: #ffffff; --text-color: #1f2937; --bg-color: #f3f4f6;
            --highlight-color: rgba(59, 130, 246, 0.5); --brand-color: #3b82f6; /* Warna biru default */
            cursor: var(--custom-cursor, auto);
        }
        .theme-dark { --primary-color: #1f2937; --text-color: #f3f4f6; --bg-color: #111827; }
        .theme-gradient { --primary-color: #ffffff; --text-color: #1f2937; --bg-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        /* Tema Baru */
        .theme-neon { --primary-color: #1a1a1a; --text-color: #00ffcc; --bg-color: #0d0d0d; --highlight-color: rgba(0, 255, 204, 0.5); --brand-color: #00ffcc; }
        .theme-minimalist { --primary-color: #ffffff; --text-color: #333333; --bg-color: #ffffff; --highlight-color: rgba(200, 200, 200, 0.5); border: 1px solid #e0e0e0; box-shadow: none !important; }
        .theme-minimalist .link-button { box-shadow: none !important; border: 1px solid #e0e0e0; }
        .theme-minimalist header img { border-width: 1px !important; border-color: #e0e0e0 !important; }

        body { font-family: var(--font-family), sans-serif; background: var(--bg-color); color: var(--text-color); }
        #app-container { background: var(--bg-color); background-size: cover; background-position: center; background-attachment: fixed; transition: background 0.5s ease; }
        .link-button { background-color: var(--primary-color); color: var(--text-color); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .link-button:hover { transform: scale(1.03); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .link-shape-rounded { border-radius: 0.75rem; } .link-shape-pill { border-radius: 9999px; } .link-shape-square { border-radius: 0px; }
        /* Gaya Tombol Baru */
        .link-style-outline { background-color: transparent !important; border: 2px solid var(--primary-color); color: var(--primary-color) !important; }
        .link-style-softshadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06) !important; }
        .link-header { color: var(--text-color); font-weight: 600; text-align: center; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        .link-thumbnail { width: 48px; height: 48px; object-cover; border-radius: 0.5rem; margin-right: 1rem; flex-shrink: 0; }
        #settings-panel::-webkit-scrollbar, #icon-picker-modal::-webkit-scrollbar { display: none; }
        #settings-panel, #icon-picker-modal { -ms-overflow-style: none; scrollbar-width: none; }
        [data-lucide] { width: 20px; height: 20px; flex-shrink: 0; }
        /* Ukuran Font */
        .font-size-small #profile-name { font-size: 1.5rem; } .font-size-small #profile-bio { font-size: 0.875rem; }
        .font-size-medium #profile-name { font-size: 1.875rem; } .font-size-medium #profile-bio { font-size: 1rem; }
        .font-size-large #profile-name { font-size: 2.25rem; } .font-size-large #profile-bio { font-size: 1.125rem; }
        /* Warna Brand */
        #verified-badge, .link-button.animate-highlight-glow { --highlight-color: var(--brand-color-semi-transparent, rgba(59, 130, 246, 0.5)); }
        #verified-badge { color: var(--brand-color); fill: var(--brand-color); }
        /* Link 2 Kolom */
        .links-2-columns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .links-2-columns .link-header { grid-column: 1 / -1; } /* Header tetap full width */
    </style>
</head>
<body class="antialiased">

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[110] flex items-center justify-center p-4">
        <div id="password-modal" class="hidden bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full"> /* ... (modal content) ... */ </div>
        <div id="sensitive-modal" class="hidden bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center"> /* ... (modal content) ... */ </div>
        <div id="icon-picker-modal" class="hidden bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full h-[80vh] flex flex-col text-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pilih Ikon (Lucide)</h3>
                <button id="close-icon-picker-btn" class="text-gray-600 hover:text-gray-900"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <input id="icon-search-input" type="text" placeholder="Cari ikon..." class="w-full p-2 border rounded-lg mb-4">
            <div id="icon-list" class="flex-1 overflow-y-auto grid grid-cols-6 gap-2 border p-2 rounded-lg bg-gray-50">
                </div>
        </div>
        <div id="contact-modal" class="hidden bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-gray-800">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Kirim Pesan</h3>
                <button id="close-contact-btn" class="text-gray-600 hover:text-gray-900"><i data-lucide="x" class="w-7 h-7"></i></button>
            </div>
            <form id="contact-form" class="space-y-4">
                <input id="contact-email" type="email" class="w-full p-3 border rounded-lg" placeholder="Email Anda (Opsional)">
                <textarea id="contact-message" rows="4" class="w-full p-3 border rounded-lg" placeholder="Pesan Anda..." required></textarea>
                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">Kirim Pesan</button>
            </form>
             <p id="contact-success-msg" class="text-green-600 text-center mt-3 hidden">Pesan terkirim!</p>
        </div>
    </div>

    <div id="app-container" class="min-h-screen w-full transition-all duration-500">
        <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-white/50 backdrop-blur-sm z-[100] p-4"> /* ... (spinner content) ... */ </div>
        <main id="main-content" class="container mx-auto max-w-2xl px-4 py-12 sm:py-20 flex flex-col items-center opacity-0 transition-opacity duration-500">
            <header class="flex flex-col items-center text-center">
                <div class="relative group">
                    <img id="profile-pic" src="https://placehold.co/128x128/e0e0e0/7f7f7f?text=Foto" alt="Foto Profil" class="w-32 h-32 rounded-full object-cover border-4 shadow-lg" style="border-color: var(--primary-color);">
                    <label for="profile-pic-upload" id="profile-pic-edit-btn" class="hidden absolute inset-0 bg-black/50 rounded-full items-center justify-center cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                        <input type="file" id="profile-pic-upload" accept="image/*" class="hidden">
                    </label>
                </div>
                <div class="flex items-center gap-2 mt-4">
                    <h1 id="profile-name" class="text-3xl font-bold" style="color: var(--text-color);">Nama Anda</h1>
                    <i id="verified-badge" data-lucide="shield-check" class="w-7 h-7 text-blue-500 fill-current hidden"></i>
                </div>
                <p id="profile-bio" class="text-lg mt-2 max-w-md" style="color: var(--text-color);">Bio singkat Anda di sini.</p>
                <p id="page-views" class="text-sm mt-2 hidden items-center gap-1" style="color: var(--text-color); opacity: 0.7;"><i data-lucide="eye" class="w-4 h-4"></i> <span>Dilihat 0 kali</span></p>
            </header>
            
            <section id="countdown-section" class="w-full max-w-md mt-8 p-4 rounded-2xl shadow-lg hidden text-center" style="background-color: var(--primary-color);"> /* ... (countdown content) ... */ </section>
            <section id="embeds-section" class="w-full max-w-md mt-8 space-y-5"> /* ... (embeds content) ... */ </section>
            <section id="donation-links-section" class="w-full max-w-md mt-8 hidden">
                <h3 class="link-header">Dukung Saya</h3>
                <div id="donation-links-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    </div>
            </section>
            <section id="links-section" class="w-full max-w-md mt-8 space-y-4"> /* ... (links content) ... */ </section>
            <section id="email-signup-section" class="w-full max-w-md mt-8 p-6 rounded-2xl shadow-lg hidden" style="background-color: var(--primary-color);"> /* ... (email signup content) ... */ </section>
            
            <footer class="text-center mt-12 w-full max-w-md">
                <button id="open-contact-btn" class="hidden mb-8 w-full bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 transition flex items-center justify-center gap-2">
                    <i data-lucide="mail"></i> Kirim Pesan
                </button>
                <div id="social-icons-section" class="flex justify-center items-center space-x-6"> /* ... (social icons) ... */ </div>
                <p id="custom-footer" class="text-sm mt-8" style="color: var(--text-color); opacity: 0.7;"> Ditenagai oleh BioLink </p>
            </footer>
        </main>
    </div>

    <div id="music-player-popup" class="hidden fixed bottom-6 left-6 z-50 flex items-center group cursor-pointer"> /* ... (music player content) ... */ </div>
    <div id="owner-controls" class="hidden fixed bottom-6 right-6 z-[101] space-x-3"> /* ... (settings button) ... */ </div>
    <aside id="settings-panel" class="fixed top-0 right-0 w-full max-w-md h-full bg-white/90 backdrop-blur-lg shadow-2xl z-[110] p-6 overflow-y-auto transform translate-x-full transition-transform duration-300 text-gray-800">
        <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold">Pengaturan</h2> <button id="close-settings-btn"><i data-lucide="x"></i></button> </div>
        <div id="save-notification" class="hidden"> /* ... (save notification) ... */ </div>
        <div class="border-b mb-6">
             <nav class="flex space-x-1 overflow-x-auto pb-2 -mb-px text-sm sm:text-base">
                <button class="tab-btn" data-tab="tab-share">Bagikan</button>
                <button class="tab-btn" data-tab="tab-general">Umum</button>
                <button class="tab-btn" data-tab="tab-links">Link</button>
                <button class="tab-btn" data-tab="tab-style">Tampilan</button>
                <button class="tab-btn" data-tab="tab-widgets">Widgets</button>
                <button class="tab-btn" data-tab="tab-security">Keamanan</button>
                <button class="tab-btn" data-tab="tab-advanced">Lanjutan</button>
            </nav>
        </div>
        <div id="tab-share" class="tab-content hidden">
            <h3 class="text-xl font-semibold mb-4">Bagikan & Preview</h3>
            <input id="share-link-input" type="text" readonly class="w-full p-2 border rounded-lg bg-gray-100 mb-2">
            <button id="copy-link-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition mb-4">Salin Link</button>
            <button id="preview-btn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition mb-6 flex items-center justify-center gap-2">
                <i data-lucide="external-link"></i> Preview Mode Pengunjung
            </button>
            <div id="qrcode-container" class="flex justify-center p-4 bg-white border rounded-lg shadow-inner mb-4"> <div id="qrcode"></div> </div>
            <div>
                 <label for="setting-qrcode-color" class="block text-sm font-medium mb-1">Warna QR Code</label>
                 <input type="color" id="setting-qrcode-color" class="w-full h-10 p-1 border rounded-lg" value="#000000">
            </div>
        </div>
        <div id="tab-general" class="tab-content hidden space-y-4">
             <h3 class="text-xl font-semibold mb-2">Info Umum</h3>
             <div> <label>Nama Tampilan</label> <input type="text" id="setting-name"> </div>
             <div> <label>Bio</label> <textarea id="setting-bio" rows="3"></textarea> </div>
             <div>
                 <label>Foto Profil</label>
                 <label for="profile-pic-upload-panel" class="w-full p-2 border rounded-lg bg-gray-100 text-gray-700 cursor-pointer flex items-center justify-center gap-2 hover:bg-gray-200">
                     <i data-lucide="upload"></i> Upload Foto
                 </label>
                 <input type="file" id="profile-pic-upload-panel" accept="image/*" class="hidden">
                 <p class="text-xs text-gray-500 mt-1">Atau tempel URL di bawah:</p>
                 <input type="url" id="setting-pic-url" class="w-full p-2 border rounded-lg mt-1" placeholder="https://...">
             </div>
             <div> <input id="setting-verified" type="checkbox"> <label for="setting-verified">Verified Badge</label> </div>
             <h3 class="text-xl font-semibold mb-2 mt-6">SEO & Favicon</h3>
             <div> <label>Judul Halaman (SEO)</label> <input type="text" id="setting-seo-title"> </div>
             <div> <label>Deskripsi Halaman (SEO)</label> <textarea id="setting-seo-desc" rows="2"></textarea> </div>
              <div>
                 <label>Favicon</label>
                 <label for="favicon-upload-panel" class="w-full p-2 border rounded-lg bg-gray-100 text-gray-700 cursor-pointer flex items-center justify-center gap-2 hover:bg-gray-200">
                     <i data-lucide="upload"></i> Upload Favicon (.ico/.png)
                 </label>
                 <input type="file" id="favicon-upload-panel" accept=".ico,.png" class="hidden">
                 <p class="text-xs text-gray-500 mt-1">Atau tempel URL di bawah:</p>
                 <input type="url" id="setting-favicon" class="w-full p-2 border rounded-lg mt-1" placeholder="https://...">
             </div>
            <button id="save-general-btn" class="w-full bg-green-600 text-white">Simpan Info Umum</button>
        </div>
        <div id="tab-links" class="tab-content hidden">
            <h3 class="text-xl font-semibold mb-4">Kelola Link & Header</h3>
            <div id="links-editor-list" class="space-y-3 mb-4"> </div>
            <button id="add-link-btn" class="w-full bg-blue-600 text-white mb-3"><i data-lucide="plus"></i> Tambah Link</button>
            <button id="add-header-btn" class="w-full bg-gray-600 text-white"><i data-lucide="type"></i> Tambah Header</button>
        </div>
        <div id="tab-style" class="tab-content hidden space-y-4">
             <h3 class="text-xl font-semibold mb-2">Gaya & Tampilan</h3>
             <div> <label>Tema</label> <div class="grid grid-cols-3 gap-3"> /* ... (tombol tema) ... */ </div> </div>
             <div>
                 <label>Background</label>
                 <label for="bg-upload-panel" class="w-full p-2 border rounded-lg bg-gray-100 cursor-pointer flex items-center justify-center gap-2 hover:bg-gray-200"> <i data-lucide="upload"></i> Upload Background </label>
                 <input type="file" id="bg-upload-panel" accept="image/*" class="hidden">
                 <p class="text-xs mt-1">Atau tempel URL:</p>
                 <input type="url" id="setting-bg-image" class="w-full mt-1" placeholder="Kosongkan untuk tema">
             </div>
             <div> <label>Font</label> <select id="setting-font"> /* ... (opsi font) ... */ </select> </div>
             <div> <label>Gaya Tombol Link</label> <select id="setting-button-style"> <option value="">Default</option> <option value="link-style-outline">Outline</option> <option value="link-style-softshadow">Soft Shadow</option> </select> </div>
             <div> <label>Bentuk Tombol Link</label> <select id="setting-button-shape"> /* ... (opsi bentuk) ... */ </select> </div>
             <div> <label>Ukuran Font Nama & Bio</label> <select id="setting-font-size"> <option value="font-size-small">Kecil</option> <option value="font-size-medium">Sedang</option> <option value="font-size-large">Besar</option> </select> </div>
             <div> <label>Warna Brand Kustom</label> <input type="color" id="setting-brand-color" class="w-full h-10 p-1 border rounded-lg" value="#3b82f6"> </div>
             <div> <label>Kursor Kustom</label> <input type="url" id="setting-cursor" placeholder="Kosongkan untuk default"> </div>
            <button id="save-style-btn" class="w-full bg-green-600 text-white">Simpan Tampilan</button>
        </div>
        <div id="tab-widgets" class="tab-content hidden space-y-4">
            <h3 class="text-xl font-semibold mb-2">Widgets</h3>
            <fieldset> <legend>Pemutar Musik</legend> <input type="url" id="setting-song-url"> <input type="text" id="setting-song-title"> </fieldset>
            <fieldset> <legend>Embed YouTube</legend> <input type="url" id="setting-video-url"> </fieldset>
            <fieldset> <legend>Embed Spotify</legend> <input type="url" id="setting-spotify-url"> </fieldset>
            <fieldset> <legend>Embed Twitch</legend> <input type="url" id="setting-twitch-url"> </fieldset>
            <fieldset> <legend>Countdown Timer</legend> <input type="text" id="setting-countdown-title"> <input type="datetime-local" id="setting-countdown-date"> </fieldset>
            <button id="save-widgets-btn" class="w-full bg-green-600 text-white">Simpan Widgets</button>
        </div>
        <div id="tab-security" class="tab-content hidden space-y-4">
            <h3 class="text-xl font-semibold mb-2">Keamanan & Akses</h3>
            <fieldset> <legend>Password Profil</legend> <input type="text" id="setting-password"> </fieldset>
            <fieldset> <legend>Peringatan Konten Sensitif</legend> <div> <input id="setting-sensitive" type="checkbox"> <label for="setting-sensitive">Aktifkan 18+</label> </div> </fieldset>
            <button id="save-security-btn" class="w-full bg-green-600 text-white">Simpan Keamanan</button>
        </div>
        <div id="tab-advanced" class="tab-content hidden space-y-4">
             <h3 class="text-xl font-semibold mb-2">Lanjutan</h3>
             <fieldset> <legend>Formulir Email/Kontak</legend> <div> <input id="setting-email-signup" type="checkbox"> <label>Aktifkan Email Signup</label> </div> <div> <input id="setting-contact-form" type="checkbox"> <label>Aktifkan Formulir Kontak</label> </div> <button id="download-emails-btn">Download Email</button> <button id="view-messages-btn">Lihat Pesan Kontak</button> </fieldset>
             <fieldset> <legend>Link Donasi</legend> <input type="url" id="donation-saweria" placeholder="Saweria URL"> <input type="url" id="donation-kofi" placeholder="Ko-fi URL"> <input type="url" id="donation-paypal" placeholder="PayPal.Me URL"> </fieldset>
             <fieldset> <legend>Ikon Sosial Media</legend> <div class="grid grid-cols-2 gap-2"> /* ... (input sosial media) ... */ </div> </fieldset>
             <fieldset> <legend>Lain-lain</legend> <div> <label>Teks Footer Kustom</label> <input type="text" id="setting-footer"> </div> <div class="mt-2"> <label>Page Views</label> <p id="page-views-admin">0 views</p> <button id="reset-views-btn">Reset</button> </div> <div> <input id="setting-two-columns" type="checkbox"> <label>Tampilkan Link 2 Kolom (Desktop)</label> </div></fieldset>
            <button id="save-advanced-btn" class="w-full bg-green-600 text-white">Simpan Lanjutan</button>
        </div>
    </aside>
    <div id="settings-overlay" class="hidden fixed inset-0 bg-black/40 z-[105]"></div>

    <script type="module">
        // --- 1. Inisialisasi Supabase ---
        const SUPABASE_URL = 'https://qvrbqtkuqgiweaeyifns.supabase.co'; // URL ANDA SUDAH DI SINI
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2cmJxdGt1cWdpd2VhZXlpZm5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NzEzNTgsImV4cCI6MjA3NDE0NzM1OH0.dY9i0-ygzx6TA2fNDcNUzI6Vecbz-s198oLbhfGqnO4'; // KEY ANDA SUDAH DI SINI
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Variabel Global ---
        let currentUserId = null; 
        let viewedProfileId = null; 
        let isOwner = false; 
        let profileData = {};
        let profileSubscription = null;
        let countdownInterval = null;
        let currentIconInputTarget = null; // Untuk icon picker

        // --- DOM Elements ---
        let dom = {};
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- Fungsi Utama ---

        async function handleAuth() {
            const { data: { session }, error } = await _supabase.auth.getSession();

            if (session?.user) {
                console.log("User session found:", session.user.id);
                currentUserId = session.user.id;
                determineViewedProfile();
            } else {
                 // Coba sign in anonim jika belum ada sesi
                console.log("No session, signing in anonymously...");
                const { data: anonUser, error: anonError } = await _supabase.auth.signInAnonymously();
                if (anonError) {
                    console.error("Error signing in anonymously:", anonError);
                    $('#loading-text').textContent = `Gagal login anonim: ${anonError.message}`;
                } else if (anonUser?.user) {
                    console.log("Signed in anonymously:", anonUser.user.id);
                    currentUserId = anonUser.user.id;
                    determineViewedProfile();
                }
            }
             // Dengarkan perubahan status auth
            _supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event, session);
                if (event === 'SIGNED_IN' && session?.user.id !== currentUserId) {
                    currentUserId = session.user.id;
                    determineViewedProfile(); // Reload data jika user berubah
                } else if (event === 'SIGNED_OUT') {
                    currentUserId = null;
                    // Handle sign out jika diperlukan (mungkin refresh halaman)
                }
            });
        }

        function determineViewedProfile() {
            const urlParams = new URLSearchParams(window.location.search);
            viewedProfileId = urlParams.get('profile') || currentUserId;
            isOwner = (currentUserId === viewedProfileId);
            
            console.log(`Current User: ${currentUserId} | Viewed Profile: ${viewedProfileId} | Is Owner: ${isOwner}`);

            if (isOwner) {
                dom.ownerControls.classList.remove('hidden');
                dom.profilePicEditBtn?.classList.remove('hidden'); // Tampilkan tombol edit foto profil
                dom.profilePicEditBtn?.classList.add('flex');
            } else {
                dom.ownerControls.classList.add('hidden');
                 dom.profilePicEditBtn?.classList.add('hidden');
                 dom.profilePicEditBtn?.classList.remove('flex');
            }
            
            loadProfileData();
        }

        async function createDefaultProfile() {
            const defaultData = {
                // ... (struktur data default sama seperti v3.0, TAPI user_id ditambah)
                user_id: viewedProfileId, // PENTING: Tambahkan user_id
                general: { name: 'Nama Anda', bio: 'Bio...', /* ... */ },
                links: [ /* ... */ ], style: { /* ... */ }, widgets: { /* ... */ },
                security: { /* ... */ }, advanced: { /* ... */ }
            };
            try {
                const { error } = await _supabase
                    .from('biolinks')
                    .insert(defaultData);
                if (error) throw error;
                console.log("Default profile created in Supabase.");
                // Tidak perlu render ulang, listener akan menangkap data baru
            } catch (e) {
                console.error("Error creating default profile in Supabase:", e);
                $('#loading-text').textContent = `Gagal membuat profil: ${e.message}`;
            }
        }

        function loadProfileData() {
            // Hentikan listener lama jika ada
            if (profileSubscription) {
                _supabase.removeChannel(profileSubscription);
                profileSubscription = null;
            }

             // Ambil data awal sekali
            fetchInitialProfile();

            // Dengarkan perubahan real-time pada tabel biolinks
            profileSubscription = _supabase.channel(`biolink_${viewedProfileId}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'biolinks', filter: `user_id=eq.${viewedProfileId}` }, 
                    payload => {
                        console.log('Realtime update received:', payload);
                         if (payload.new) {
                            profileData = payload.new;
                            checkSecurity(profileData.security);
                            renderProfileView(profileData);
                            if (isOwner) renderSettingsPanel(profileData);
                         } else if (payload.eventType === 'DELETE') {
                             // Handle jika profil dihapus
                             $('#loading-text').textContent = 'Profil ini telah dihapus.';
                             dom.loadingSpinner.classList.remove('hidden');
                             dom.mainContent.classList.add('opacity-0');
                         }
                    }
                )
                .subscribe();
        }

        async function fetchInitialProfile() {
             try {
                const { data, error } = await _supabase
                    .from('biolinks')
                    .select('*')
                    .eq('user_id', viewedProfileId)
                    .single(); // Ambil satu baris

                if (error && error.code !== 'PGRST116') { // Abaikan error 'not found'
                    throw error;
                }

                if (data) {
                    dom.loadingSpinner.classList.add('hidden');
                    dom.mainContent.classList.remove('opacity-0');
                    profileData = data;
                    console.log("Profile data loaded from Supabase:", profileData);
                    checkSecurity(profileData.security);
                    renderProfileView(profileData);
                    if (isOwner) {
                         renderSettingsPanel(profileData);
                         updateAdminStats(); 
                    } else {
                        logPageView();
                    }
                } else {
                     // Profil tidak ditemukan
                    console.log("No such profile in Supabase!");
                    if (isOwner) {
                        console.log("Creating default profile for owner...");
                        createDefaultProfile(); // Buatkan profil default
                    } else {
                        $('#loading-text').textContent = 'Profil tidak ditemukan.';
                        dom.loadingSpinner.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("Error loading profile data from Supabase:", error);
                 $('#loading-text').innerHTML = `Gagal memuat profil. <br><b class="text-red-600">Error: ${error.message}</b> <br> Cek koneksi atau setup Supabase Anda.`;
                dom.loadingSpinner.classList.remove('hidden');
            }
        }

        // --- Fungsi Upload File (Supabase Storage) ---
        
        async function handleFileUpload(file, bucket, pathPrefix = '') {
            if (!file) return null;
            const fileExt = file.name.split('.').pop();
            const fileName = `${pathPrefix}${Date.now()}.${fileExt}`;
            const filePath = `${currentUserId}/${fileName}`; // Simpan di folder user

            try {
                $('#loading-text').textContent = `Mengupload ${file.name}...`;
                dom.loadingSpinner.classList.remove('hidden');

                const { error: uploadError } = await _supabase.storage
                    .from(bucket)
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                 // Dapatkan URL publik
                const { data } = _supabase.storage
                    .from(bucket)
                    .getPublicUrl(filePath);
                
                dom.loadingSpinner.classList.add('hidden');
                console.log(`File uploaded to ${bucket}:`, data.publicUrl);
                return data.publicUrl;

            } catch (error) {
                console.error('Error uploading file:', error);
                 $('#loading-text').textContent = `Gagal upload: ${error.message}`;
                 // Jangan sembunyikan spinner jika error
                return null;
            }
        }

        // --- Render, Simpan, Aksi (Sebagian besar sama, update pakai Supabase) ---

        function renderProfileView(data) {
             // ... (Kode render sebagian besar sama, pastikan semua field ada di 'data')
             const { general, links, style, widgets, advanced } = data;

             // Terapkan Font Size & Brand Color
             document.body.className = `antialiased ${style.fontSize || 'font-size-medium'}`;
             document.documentElement.style.setProperty('--brand-color', style.brandColor || '#3b82f6');
             document.documentElement.style.setProperty('--brand-color-semi-transparent', hexToRgba(style.brandColor || '#3b82f6', 0.5));

            // ... (Kode render lainnya: SEO, Style, General, Links)
            
            // Render Links
            dom.linksSection.innerHTML = '';
            dom.linksSection.className = `w-full max-w-md mt-8 space-y-4 ${advanced.twoColumns ? 'sm:links-2-columns' : ''}`; // Terapkan 2 kolom
            if (links && links.length > 0) {
                 links.forEach(link => {
                     // Cek Jadwal Link (Fitur Baru)
                     const now = new Date().getTime();
                     const start = link.scheduleStart ? new Date(link.scheduleStart).getTime() : 0;
                     const end = link.scheduleEnd ? new Date(link.scheduleEnd).getTime() : Infinity;
                     if (now < start || now > end) return; // Lewati jika di luar jadwal

                     if (link.type === 'header') { /* ... render header ... */ }
                     else if (link.type === 'link') {
                         const linkEl = document.createElement('a');
                         // ... (set href, target, dataset)
                         linkEl.className = `link-button w-full p-3 shadow-lg flex items-center relative font-semibold ${style.buttonShape || 'link-shape-pill'} ${style.buttonStyle || ''} ${link.animation !== 'none' ? `animate-${link.animation}` : ''} ${link.highlight ? 'animate-highlight-glow' : ''}`;
                         // ... (inner HTML dengan thumbnail)
                         linkEl.addEventListener('click', handleLinkClick);
                         dom.linksSection.appendChild(linkEl);
                     }
                 });
             }

            // Render Widgets (Musik, Embeds, Countdown)
            // ... (Kode widget sama)

            // Render Donation Links (Fitur Baru)
            const donationLinksList = $('#donation-links-list');
            donationLinksList.innerHTML = '';
            let hasDonation = false;
            const donationMap = { saweria: 'Coffee', kofi: 'Gift', paypal: 'Paypal' }; // Icon Lucide
            if (advanced.donations) {
                for (const [key, icon] of Object.entries(donationMap)) {
                    if (advanced.donations[key]) {
                        hasDonation = true;
                        const btn = document.createElement('a');
                        btn.href = advanced.donations[key];
                        btn.target = '_blank';
                        btn.className = 'link-button p-3 rounded-lg shadow flex flex-col items-center justify-center text-center !bg-opacity-80 hover:!bg-opacity-100'; // Pakai !bg-opacity
                        btn.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">${key.charAt(0).toUpperCase() + key.slice(1)}</span>`;
                        donationLinksList.appendChild(btn);
                    }
                }
            }
            $('#donation-links-section').classList.toggle('hidden', !hasDonation);

            // Render Advanced (Email Signup, Kontak, Footer, Socials)
            dom.emailSignupSection.classList.toggle('hidden', !advanced.emailSignup);
            $('#open-contact-btn').classList.toggle('hidden', !advanced.contactForm);
            dom.customFooter.textContent = advanced.footerText || '';
            // ... (render social icons)

             if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderSettingsPanel(data) {
             // ... (Kode render panel sebagian besar sama)
             
             // Tambahkan field baru ke render
             // Style
             $('#setting-button-style').value = style.buttonStyle || '';
             $('#setting-font-size').value = style.fontSize || 'font-size-medium';
             $('#setting-brand-color').value = style.brandColor || '#3b82f6';

             // Advanced
             $('#setting-contact-form').checked = advanced.contactForm || false;
             $('#donation-saweria').value = advanced.donations?.saweria || '';
             $('#donation-kofi').value = advanced.donations?.kofi || '';
             $('#donation-paypal').value = advanced.donations?.paypal || '';
             $('#setting-two-columns').checked = advanced.twoColumns || false;

             // Link Editor (Tambahkan Jadwal)
             // Di dalam loop `links.forEach`:
             // ...
             // else { // Bagian untuk link
             //   editorEl.innerHTML = `...
             //       <h4 class="text-xs font-medium mt-3 mb-1 text-gray-600">Jadwal Tampil (Opsional)</h4>
             //       <div class="flex gap-2 text-xs">
             //           <input type="datetime-local" class="setting-link-schedule-start w-full p-1 border rounded" value="${link.scheduleStart || ''}">
             //           <input type="datetime-local" class="setting-link-schedule-end w-full p-1 border rounded" value="${link.scheduleEnd || ''}">
             //       </div>
             //   ...`;
             // }
        }

        async function saveAllSettings() {
             // ... (Ambil data 'general', 'style', 'widgets', 'security', 'advanced' dari form)
             
             // Tambahkan field baru ke pengambilan data
             // Style
             const style = {
                 // ... (tema, bg, font, buttonShape, cursor)
                 buttonStyle: $('#setting-button-style').value,
                 fontSize: $('#setting-font-size').value,
                 brandColor: $('#setting-brand-color').value
             };
             // Advanced
              const advanced = {
                 // ... (emailSignup, footer, socials)
                 contactForm: $('#setting-contact-form').checked,
                 donations: {
                     saweria: $('#donation-saweria').value,
                     kofi: $('#donation-kofi').value,
                     paypal: $('#donation-paypal').value,
                 },
                 twoColumns: $('#setting-two-columns').checked
             };
             // Links (Tambahkan Jadwal)
              // Di dalam loop `$$('#links-editor-list > div').forEach`:
              // ...
              // else { // Bagian untuk link
              //   links.push({
              //       // ... (id, type, title, url, thumbnail, icon, animation, highlight, clicks)
              //       scheduleStart: editorEl.querySelector('.setting-link-schedule-start').value || null,
              //       scheduleEnd: editorEl.querySelector('.setting-link-schedule-end').value || null,
              //   });
              // }

             const fullData = { user_id: currentUserId, /* ... semua field data ... */ };
             // Hapus field 'created_at' jika ada, Supabase tidak suka di-update
             delete fullData.created_at; 
             
             try {
                 const { error } = await _supabase
                    .from('biolinks')
                    .update(fullData)
                    .eq('user_id', currentUserId);
                 if (error) throw error;
                 showSaveNotification();
             } catch (e) { console.error("Error saving settings to Supabase:", e); }
        }

        // --- Fungsi Baru (Icon Picker, Kontak, Upload Handler) ---

        async function loadLucideIcons() {
             // Fetch daftar ikon dari unpkg (atau sumber lain)
             // Lalu render di #icon-list
             // Tambahkan event listener untuk memilih ikon
        }
        
        function openIconPicker(inputTarget) {
            currentIconInputTarget = inputTarget;
            dom.modalOverlay.classList.remove('hidden');
            dom.iconPickerModal.classList.remove('hidden');
            // Fokus ke search input jika perlu
        }
        
        function selectIcon(iconName) {
            if (currentIconInputTarget) {
                currentIconInputTarget.value = iconName;
                // Trigger change event untuk simpan otomatis
                 const changeEvent = new Event('change', { bubbles: true });
                 currentIconInputTarget.dispatchEvent(changeEvent);
            }
            closeIconPicker();
        }

        function closeIconPicker() {
            dom.modalOverlay.classList.add('hidden');
            dom.iconPickerModal.classList.add('hidden');
             currentIconInputTarget = null;
        }

        function openContactForm() {
             dom.modalOverlay.classList.remove('hidden');
             dom.contactModal.classList.remove('hidden');
        }
        
        function closeContactForm() {
             dom.modalOverlay.classList.add('hidden');
             dom.contactModal.classList.add('hidden');
             // Reset form
             dom.contactForm.reset();
             $('#contact-success-msg').classList.add('hidden');
        }

        async function handleContactSubmit(e) {
            e.preventDefault();
            const message = $('#contact-message').value;
            const email = $('#contact-email').value || null; // Opsional
            
            try {
                const { error } = await _supabase.from('contacts').insert({
                    profile_id: viewedProfileId, // ID profil yang dikontak
                    sender_email: email,
                    message: message
                });
                if (error) throw error;
                $('#contact-success-msg').classList.remove('hidden');
                 dom.contactForm.reset();
                 setTimeout(closeContactForm, 3000); // Tutup otomatis setelah 3 detik
            } catch (error) {
                 console.error("Error sending contact message:", error);
                 alert(`Gagal mengirim pesan: ${error.message}`);
            }
        }
        
        async function viewContactMessages() {
             // Ambil pesan dari Supabase dan tampilkan (misal, di alert atau modal baru)
             try {
                 const { data, error } = await _supabase
                    .from('contacts')
                    .select('sender_email, message, created_at')
                    .eq('profile_id', currentUserId) // Hanya pesan untuk owner
                    .order('created_at', { ascending: false }); 
                 if (error) throw error;
                 
                 if (data.length === 0) {
                     alert("Belum ada pesan masuk.");
                     return;
                 }

                 let messageLog = "Pesan Masuk:\n\n";
                 data.forEach(msg => {
                     const date = new Date(msg.created_at).toLocaleString();
                     messageLog += `Dari: ${msg.sender_email || 'Anonim'} (${date})\nPesan: ${msg.message}\n---\n`;
                 });
                 alert(messageLog); // Tampilkan di alert sederhana
                 
             } catch (error) {
                 console.error("Error fetching contact messages:", error);
                 alert(`Gagal mengambil pesan: ${error.message}`);
             }
        }
        
        // Handler untuk tombol upload
        async function setupUploadHandlers() {
             // Profile Pic
             $('#profile-pic-upload, #profile-pic-upload-panel').onchange = async (e) => {
                 const file = e.target.files[0];
                 const publicUrl = await handleFileUpload(file, 'profile-pics');
                 if (publicUrl) {
                     $('#setting-pic-url').value = publicUrl;
                     saveAllSettings(); // Simpan otomatis
                 }
                 e.target.value = null; // Reset input file
             };
             // Background
             $('#bg-upload-panel').onchange = async (e) => {
                  const file = e.target.files[0];
                  const publicUrl = await handleFileUpload(file, 'backgrounds');
                  if (publicUrl) {
                     $('#setting-bg-image').value = publicUrl;
                     saveAllSettings();
                 }
                  e.target.value = null;
             };
             // Favicon
             $('#favicon-upload-panel').onchange = async (e) => {
                 const file = e.target.files[0];
                 const publicUrl = await handleFileUpload(file, 'favicons');
                 if (publicUrl) {
                     $('#setting-favicon').value = publicUrl;
                     saveAllSettings();
                 }
                 e.target.value = null;
             };
             // Thumbnail Link (Event Delegation)
            $('#links-editor-list').addEventListener('change', async (e) => {
                if (e.target.classList.contains('setting-link-thumbnail-upload')) {
                    const file = e.target.files[0];
                    const publicUrl = await handleFileUpload(file, 'thumbnails', 'thumb-');
                     if (publicUrl) {
                        // Cari input URL thumbnail yang sesuai dan isi nilainya
                         const urlInput = e.target.closest('.space-y-2').querySelector('.setting-link-thumbnail');
                         if(urlInput) urlInput.value = publicUrl;
                         saveAllSettings(); // Simpan semua
                     }
                    e.target.value = null;
                 }
            });
        }
        
         // --- Helper Functions ---
         function hexToRgba(hex, alpha) { /* ... (kode konversi hex ke rgba) ... */ }
         // ... (fungsi toggleMusic, convertToEmbedUrl, loadCustomFonts)

        // --- Inisialisasi Aplikasi ---
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Loaded. Initializing app v4.0 (Full Supabase)...");
            
            // Definisi DOM (pastikan semua ID sesuai)
            dom = { /* ... (semua elemen DOM) ... */ };

            loadCustomFonts();
            loadLucideIcons(); // Muat ikon untuk picker

            // --- Event Listeners ---
            // ... (listener musik, modal, panel, tab, simpan, link, email, download, reset views, tema) ...
            
            // Listener Baru
            $('#preview-btn').onclick = () => window.open(dom.shareLinkInput.value, '_blank');
            $('#close-icon-picker-btn').onclick = closeIconPicker;
            $('#open-contact-btn').onclick = openContactForm;
            $('#close-contact-btn').onclick = closeContactForm;
            dom.contactForm.onsubmit = handleContactSubmit;
            $('#view-messages-btn').onclick = viewContactMessages;
             // Event delegation untuk tombol icon picker
            $('#links-editor-list').addEventListener('click', (e) => {
                 const iconButton = e.target.closest('.btn-open-icon-picker');
                 if (iconButton) {
                     const inputTarget = iconButton.previousElementSibling; // Input icon
                     openIconPicker(inputTarget);
                 }
             });
             // Setup listener untuk tombol upload file
            setupUploadHandlers();

            if (_supabase) handleAuth();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });
    </script>

</body>
</html>