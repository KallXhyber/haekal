<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLink Profile</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- 3. QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <!-- 4. Konfigurasi Tailwind & Font Kustom -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['var(--font-family)', 'ui-sans-serif', 'system-ui'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 1s cubic-bezier(.36,.07,.19,.97) both infinite',
                        'bounce-fast': 'bounce 0.8s infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 5. Custom Styles -->
    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            --primary-color: #ffffff;
            --text-color: #1f2937;
            --bg-color: #f3f4f6;
        }
        
        /* Tema Gelap */
        .theme-dark {
            --primary-color: #1f2937;
            --text-color: #f3f4f6;
            --bg-color: #111827;
        }

        /* Tema Gradien */
        .theme-gradient {
            --primary-color: #ffffff;
            --text-color: #1f2937;
            --bg-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: var(--font-family), sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        #app-container {
            background: var(--bg-color);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background 0.5s ease;
        }
        
        .link-button {
            background-color: var(--primary-color);
            color: var(--text-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .link-button:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #settings-panel::-webkit-scrollbar { display: none; }
        #settings-panel { -ms-overflow-style: none; scrollbar-width: none; }
        [data-lucide] { width: 20px; height: 20px; }
    </style>
</head>
<body class="antialiased">

    <!-- ===== MAIN APP CONTAINER ===== -->
    <div id="app-container" class="min-h-screen w-full transition-all duration-500">
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-white/50 backdrop-blur-sm z-[100]">
            <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        
        <!-- Pesan Error (misal: profil tidak ditemukan) -->
        <div id="error-message" class="hidden fixed inset-0 flex items-center justify-center bg-white/50 backdrop-blur-sm z-[99]">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <h2 class="text-2xl font-bold text-red-600 mb-4">Profil Tidak Ditemukan</h2>
                <p class="text-gray-700">Profil yang Anda cari tidak ada atau belum dibuat.</p>
                <button id="go-home-btn" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Kembali ke Profil Saya</button>
            </div>
        </div>

        <!-- Konten Utama -->
        <main id="main-content" class="container mx-auto max-w-2xl px-4 py-12 sm:py-20 flex flex-col items-center opacity-0 transition-opacity duration-500">
            
            <!-- 1. Profile Section -->
            <header class="flex flex-col items-center text-center">
                <img id="profile-pic" src="https://placehold.co/128x128/e0e0e0/7f7f7f?text=Foto" 
                     alt="Foto Profil" 
                     class="w-32 h-32 rounded-full object-cover border-4 shadow-lg"
                     style="border-color: var(--primary-color);">
                <h1 id="profile-name" class="text-3xl font-bold mt-4" style="color: var(--text-color);">Nama Anda</h1>
                <p id="profile-bio" class="text-lg mt-2 max-w-md" style="color: var(--text-color);">Bio singkat Anda di sini. Ceritakan sedikit tentang diri Anda.</p>
            </header>
            
            <!-- 2. YouTube Embed (Fitur Tambahan) -->
            <section id="video-embed-section" class="w-full max-w-md mt-8 rounded-xl overflow-hidden shadow-lg hidden">
                <iframe id="video-iframe" class="w-full aspect-video" 
                        src="" 
                        title="YouTube video player" frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </section>
            
            <!-- 3. Links Section -->
            <section id="links-section" class="w-full max-w-md mt-8 space-y-5">
                <!-- Link dinamis akan ditambahkan di sini oleh JS -->
            </section>
            
            <!-- 4. Email Signup (Fitur Tambahan) -->
            <section id="email-signup-section" class="w-full max-w-md mt-8 p-6 rounded-2xl shadow-lg hidden" style="background-color: var(--primary-color);">
                <h3 class="text-lg font-semibold text-center mb-3" style="color: var(--text-color);">Berlangganan Newsletter Saya</h3>
                <form id="email-form" class="flex flex-col sm:flex-row gap-3">
                    <input id="email-input" type="email" placeholder="Email Anda..." class="flex-1 px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900" required>
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-full hover:bg-blue-700 transition">Kirim</button>
                </form>
                <p id="email-success-msg" class="text-green-600 text-center mt-3 hidden">Terima kasih telah berlangganan!</p>
                <p id="email-error-msg" class="text-red-600 text-center mt-3 hidden">Gagal menyimpan email.</p>
            </section>
            
            <!-- 5. Social Icons (Fitur Tambahan) -->
            <footer id="social-icons-section" class="flex justify-center items-center space-x-6 mt-12">
                <!-- Ikon sosial dinamis akan ditambahkan di sini -->
            </footer>
            
        </main>
    </div>

    <!-- ===== MUSIC PLAYER POPUP ===== -->
    <div id="music-player-popup" class="fixed bottom-6 left-6 z-50 flex items-center group cursor-pointer">
        <div id="music-icon-container" class="w-14 h-14 bg-white rounded-full shadow-2xl flex items-center justify-center text-blue-600 hover:scale-110 transition-transform">
            <i data-lucide="music" class="w-7 h-7"></i>
            <i data-lucide="pause" class="w-7 h-7 hidden"></i>
        </div>
        <div id="song-title-bubble" class="ml-3 bg-white shadow-2xl px-5 py-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
            <span id="song-title" class="font-semibold text-gray-800">Nama Lagu - Artis</span>
        </div>
        <audio id="audio-player" src=""></audio>
    </div>

    <!-- ===== OWNER-ONLY BUTTONS ===== -->
    <div id="owner-controls" class="hidden fixed bottom-6 right-6 z-50 space-x-3">
        <!-- Tombol Buka/Tutup Settings -->
        <button id="toggle-settings-btn" class="w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:bg-blue-700 transition-transform hover:scale-110" title="Buka Pengaturan">
            <i data-lucide="settings" class="w-7 h-7"></i>
        </button>
    </div>

    <!-- ===== SETTINGS PANEL ===== -->
    <aside id="settings-panel" class="hidden fixed top-0 right-0 w-full max-w-md h-full bg-white/90 backdrop-blur-lg shadow-2xl z-[60] p-6 overflow-y-auto transform translate-x-full transition-transform duration-300 text-gray-800">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Pengaturan BioLink</h2>
            <button id="close-settings-btn" class="text-gray-600 hover:text-gray-900">
                <i data-lucide="x" class="w-7 h-7"></i>
            </button>
        </div>
        
        <!-- Notifikasi Simpan -->
        <div id="save-notification" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-4 hidden" role="alert">
            <strong class="font-bold">Sukses!</strong>
            <span class="block sm:inline">Perubahan telah disimpan.</span>
        </div>
        
        <!-- Tab Navigasi -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button class="tab-btn" data-tab="tab-share">Bagikan</button>
                <button class="tab-btn" data-tab="tab-general">Umum</button>
                <button class="tab-btn" data-tab="tab-links">Link</button>
                <button class="tab-btn" data-tab="tab-style">Tampilan</button>
                <button class="tab-btn" data-tab="tab-extras">Tambahan</button>
            </nav>
        </div>

        <!-- Konten Tab -->
        
        <!-- Tab 1: Share / Bagikan -->
        <div id="tab-share" class="tab-content hidden">
            <h3 class="text-xl font-semibold mb-4">Bagikan Profil Anda</h3>
            <p class="text-sm mb-2">Gunakan link atau QR code ini untuk membagikan profil Anda ke semua orang.</p>
            <input id="share-link-input" type="text" readonly class="w-full p-2 border rounded-lg bg-gray-100 mb-4">
            <button id="copy-link-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition mb-6">Salin Link</button>
            
            <div id="qrcode-container" class="flex justify-center p-4 bg-white border rounded-lg shadow-inner">
                <div id="qrcode" class="w-48 h-48"></div>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">Pindai kode ini untuk membuka profil.</p>
        </div>

        <!-- Tab 2: General / Umum -->
        <div id="tab-general" class="tab-content hidden space-y-4">
            <h3 class="text-xl font-semibold mb-4">Pengaturan Umum</h3>
            <div>
                <label for="setting-name" class="block text-sm font-medium mb-1">Nama Tampilan</label>
                <input type="text" id="setting-name" class="w-full p-2 border rounded-lg" placeholder="Nama Anda">
            </div>
            <div>
                <label for="setting-bio" class="block text-sm font-medium mb-1">Bio</label>
                <textarea id="setting-bio" rows="3" class="w-full p-2 border rounded-lg" placeholder="Bio singkat Anda..."></textarea>
            </div>
            <div>
                <label for="setting-pic-url" class="block text-sm font-medium mb-1">URL Foto Profil</label>
                <input type="url" id="setting-pic-url" class="w-full p-2 border rounded-lg" placeholder="https://.../gambar.png">
            </div>
            <button id="save-general-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Simpan Pengaturan Umum</button>
        </div>
        
        <!-- Tab 3: Links / Link -->
        <div id="tab-links" class="tab-content hidden">
            <h3 class="text-xl font-semibold mb-4">Kelola Link</h3>
            <div id="links-editor-list" class="space-y-3 mb-4">
                <!-- Editor link dinamis akan ditambahkan di sini -->
            </div>
            <button id="add-link-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <i data-lucide="plus"></i> Tambah Link Baru
            </button>
        </div>
        
        <!-- Tab 4: Style / Tampilan -->
        <div id="tab-style" class="tab-content hidden space-y-4">
            <h3 class="text-xl font-semibold mb-4">Gaya & Tampilan</h3>
            
            <!-- Pilihan Tema -->
            <div>
                <label class="block text-sm font-medium mb-2">Tema</label>
                <div class="grid grid-cols-3 gap-3">
                    <button class="theme-select-btn" data-theme="theme-light">
                        <div class="w-full h-16 bg-gray-100 border-2 rounded-lg flex items-center justify-center">Terang</div>
                    </button>
                    <button class="theme-select-btn" data-theme="theme-dark">
                        <div class="w-full h-16 bg-gray-900 text-white border-2 rounded-lg flex items-center justify-center">Gelap</div>
                    </button>
                    <button class="theme-select-btn" data-theme="theme-gradient">
                        <div class="w-full h-16 bg-gradient-to-r from-blue-500 to-purple-600 text-white border-2 rounded-lg flex items-center justify-center">Gradien</div>
                    </button>
                </div>
            </div>
            
            <!-- Pilihan Background -->
            <div>
                <label for="setting-bg-image" class="block text-sm font-medium mb-1">URL Gambar Background (Opsional)</label>
                <input type="url" id="setting-bg-image" class="w-full p-2 border rounded-lg" placeholder="https://.../background.png">
                <p class="text-xs text-gray-500 mt-1">Akan menimpa warna tema. Kosongkan untuk menggunakan warna tema.</p>
            </div>
            
            <!-- Pilihan Font -->
            <div>
                <label for="setting-font" class="block text-sm font-medium mb-1">Font</label>
                <select id="setting-font" class="w-full p-2 border rounded-lg bg-white">
                    <option value="'Inter', sans-serif">Inter (Default)</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Lobster', cursive">Lobster</option>
                    <option value="'Roboto Slab', serif">Roboto Slab</option>
                    <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                </select>
            </div>
            
            <button id="save-style-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Simpan Tampilan</button>
        </div>
        
        <!-- Tab 5: Extras / Tambahan -->
        <div id="tab-extras" class="tab-content hidden space-y-4">
            <h3 class="text-xl font-semibold mb-4">Fitur Tambahan</h3>
            
            <!-- Pengaturan Musik -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-medium px-1">Pemutar Musik</legend>
                <div>
                    <label for="setting-song-url" class="block text-sm font-medium mb-1">URL Lagu (.mp3)</label>
                    <input type="url" id="setting-song-url" class="w-full p-2 border rounded-lg" placeholder="https://.../lagu.mp3">
                </div>
                <div class="mt-2">
                    <label for="setting-song-title" class="block text-sm font-medium mb-1">Judul Lagu</label>
                    <input type="text" id="setting-song-title" class="w-full p-2 border rounded-lg" placeholder="Nama Lagu - Artis">
                </div>
            </fieldset>
            
            <!-- Pengaturan Video Embed -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-medium px-1">Embed Video YouTube</legend>
                <div>
                    <label for="setting-video-url" class="block text-sm font-medium mb-1">URL Video YouTube</label>
                    <input type="url" id="setting-video-url" class="w-full p-2 border rounded-lg" placeholder="https://www.youtube.com/watch?v=...">
                    <p class="text-xs text-gray-500 mt-1">Kosongkan untuk menyembunyikan video.</p>
                </div>
            </fieldset>

            <!-- Pengaturan Email Signup -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-medium px-1">Formulir Email</legend>
                <div class="flex items-center">
                    <input id="setting-email-signup" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="setting-email-signup" class="ml-2 block text-sm">Tampilkan formulir pendaftaran email</label>
                </div>
                <button id="download-emails-btn" class="mt-3 w-full bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition text-sm">Download Daftar Email (.csv)</button>
            </fieldset>
            
            <!-- Pengaturan Ikon Sosial -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-medium px-1">Ikon Sosial Media</legend>
                <p class="text-xs text-gray-500 mb-2">Masukkan URL lengkap. Kosongkan untuk menyembunyikan.</p>
                <div class="space-y-2">
                    <input type="url" id="social-instagram" class="w-full p-2 border rounded-lg" placeholder="Instagram (https://instagram.com/...)">
                    <input type="url" id="social-twitter" class="w-full p-2 border rounded-lg" placeholder="X / Twitter (https://x.com/...)">
                    <input type="url" id="social-facebook" class="w-full p-2 border rounded-lg" placeholder="Facebook (https://facebook.com/...)">
                    <input type="url" id="social-linkedin" class="w-full p-2 border rounded-lg" placeholder="LinkedIn (https://linkedin.com/in/...)">
                    <input type="url" id="social-github" class="w-full p-2 border rounded-lg" placeholder="GitHub (https://github.com/...)">
                    <input type="url" id="social-tiktok" class="w-full p-2 border rounded-lg" placeholder="TikTok (https://tiktok.com/@...)">
                </div>
            </fieldset>
            
            <button id="save-extras-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Simpan Pengaturan Tambahan</button>
        </div>
        
    </aside>

    <!-- Overlay untuk panel setting -->
    <div id="settings-overlay" class="hidden fixed inset-0 bg-black/40 z-50"></div>

    <!-- ===== SCRIPT UTAMA ===== -->
    <script type="module">
        // --- 1. Impor Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            addDoc,
            serverTimestamp,
            arrayUnion,
            increment,
            getDocs // Ditambahkan untuk download CSV
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 2. Inisialisasi Firebase ---
        
        // !!! PENTING UNTUK DEPLOYMENT VERCEL !!!
        // Ganti object kosong {} di bawah dengan Firebase Config Anda
        // Anda bisa mendapatkannya dari Firebase Console:
        // Project Settings > General > Your apps > Web app > SDK setup and configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgQRwRFjKOXZI9pm40r3mdHZRHhC43dRU",
            authDomain: "xykallweb.firebaseapp.com",
            projectId: "xykallweb",
            storageBucket: "xykallweb.firebasestorage.app",
            messagingSenderId: "168467365781",
            appId: "1:168467365781:web:572a3b567bc0e905b9809c",
        };
        
        // ID unik untuk aplikasi ini di database. Anda bisa ganti jika mau.
        // Ini menggantikan '__app_id'
        const appId = '1:168467365781:web:572a3b567bc0e905b9809c'; 
        
        // Token autentikasi tidak ada di Vercel, jadi kita akan login anonim.
        // Ini menggantikan '__initial_auth_token'
        const initialAuthToken = null; 
        
        let app, auth, db;
        let currentUserId = null; // User ID pemilik browser
        let viewedProfileId = null; // User ID profil yang sedang dilihat
        let isOwner = false; // Apakah pemilik browser = pemilik profil
        let profileData = {}; // Data profil yang sedang dilihat
        let profileDocRef = null; // Referensi ke dokumen profil
        let unsubscribeProfile = null; // Fungsi untuk stop listener onSnapshot

        // Inisialisasi Firebase
        try {
            // Cek jika config sudah diisi
            if (firebaseConfig.apiKey === "AIzaSyCgQRwRFjKOXZI9pm40r3mdHZRHhC43dRU") {
                throw new Error("Firebase config belum diisi. Silakan edit file index.html.");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error initializing Firebase: ", e);
            const loadingSpinner = document.getElementById('loading-spinner');
            if(loadingSpinner) {
                loadingSpinner.innerHTML = `Gagal memuat aplikasi. Cek console. <br> Error: ${e.message}`;
            }
        }

        // --- 3. Variabel DOM ---
        let dom = {};
        let $ = (selector) => document.querySelector(selector);
        let $$ = (selector) => document.querySelectorAll(selector);

        // --- 4. Fungsi Utama Aplikasi ---
        
        /**
         * Autentikasi Pengguna
         */
        async function handleAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User authenticated:", user.uid);
                    currentUserId = user.uid;
                    // Tentukan profil siapa yang akan ditampilkan
                    determineViewedProfile();
                } 
                // PERBAIKAN: Hapus 'else if (initialAuthToken)' karena tidak ada di Vercel
                else {
                    console.log("Signing in anonymously...");
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Error signing in anonymously:", e);
                    }
                }
            });
        }

        /**
         * Tentukan profil siapa yang akan dilihat berdasarkan URL
         */
        function determineViewedProfile() {
            const urlParams = new URLSearchParams(window.location.search);
            viewedProfileId = urlParams.get('profile') || currentUserId;
            isOwner = (currentUserId === viewedProfileId);
            
            console.log(`Current User: ${currentUserId}`);
            console.log(`Viewed Profile: ${viewedProfileId}`);
            console.log(`Is Owner: ${isOwner}`);

            // Tampilkan tombol pengaturan HANYA jika dia pemilik
            if (isOwner) {
                dom.ownerControls.classList.remove('hidden');
            } else {
                dom.ownerControls.classList.add('hidden');
            }
            
            // Set doc ref. Gunakan path "public" agar bisa dibaca semua orang
            // PERBAIKAN: Gunakan 'appId' yang sudah didefinisikan di atas
            const collectionPath = `artifacts/${appId}/public/data/biolink_profiles`;
            profileDocRef = doc(db, collectionPath, viewedProfileId);
            
            // Mulai mendengarkan data profil
            loadProfileData();
        }

        /**
         * Buat profil default untuk pengguna baru
         */
        async function createDefaultProfile() {
            const defaultData = {
                general: {
                    name: 'Nama Anda',
                    bio: 'Bio singkat Anda di sini.',
                    picUrl: 'https://placehold.co/128x128/e0e0e0/7f7f7f?text=Foto'
                },
                links: [
                    { 
                        id: crypto.randomUUID(), 
                        title: 'Link Contoh 1 (Edit Saya)', 
                        url: '#', 
                        icon: 'link',
                        animation: 'none',
                        clicks: 0
                    },
                    { 
                        id: crypto.randomUUID(), 
                        title: 'Link Contoh 2 (Edit Saya)', 
                        url: '#', 
                        icon: 'link',
                        animation: 'none',
                        clicks: 0
                    }
                ],
                style: {
                    theme: 'theme-light',
                    bgImage: '',
                    font: "'Inter', sans-serif"
                },
                extras: {
                    songUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // Contoh lagu
                    songTitle: 'SoundHelix Song 1 - T. SchÃ¼rger',
                    videoUrl: '',
                    emailSignup: false,
                    socials: {
                        instagram: '', twitter: '', facebook: '',
                        linkedin: '', github: '', tiktok: ''
                    }
                },
                createdAt: serverTimestamp()
            };
            try {
                await setDoc(profileDocRef, defaultData);
                console.log("Default profile created.");
                // onSnapshot akan otomatis mengambil data baru ini
            } catch (e) {
                console.error("Error creating default profile:", e);
            }
        }

        /**
         * Ambil dan dengarkan perubahan data profil dari Firestore
         */
        function loadProfileData() {
            if (unsubscribeProfile) unsubscribeProfile(); // Hentikan listener lama jika ada

            unsubscribeProfile = onSnapshot(profileDocRef, (docSnap) => {
                // Pastikan DOM sudah siap
                if (!dom.loadingSpinner) {
                    console.warn("DOM not ready, skipping snapshot render");
                    return;
                }
                
                dom.loadingSpinner.classList.add('hidden');
                
                if (docSnap.exists()) {
                    dom.errorMessage.classList.add('hidden');
                    dom.mainContent.classList.remove('opacity-0');
                    
                    profileData = docSnap.data();
                    console.log("Profile data loaded:", profileData);
                    
                    // Render tampilan utama
                    renderProfileView(profileData);
                    
                    // Jika pemilik, render juga panel pengaturan
                    if (isOwner) {
                        renderSettingsPanel(profileData);
                    }
                } else {
                    // Profil tidak ditemukan
                    console.log("No such profile!");
                    if (isOwner) {
                        // Jika dia pemilik, buatkan profil default
                        console.log("Creating default profile for owner...");
                        createDefaultProfile();
                    } else {
                        // Jika dia tamu, tampilkan pesan error
                        dom.errorMessage.classList.remove('hidden');
                        dom.mainContent.classList.add('opacity-0');
                    }
                }
            }, (error) => {
                console.error("Error loading profile data:", error);
                dom.loadingSpinner.innerHTML = 'Gagal memuat profil.';
            });
        }
        
        /**
         * Render tampilan utama (yang dilihat publik)
         */
        function renderProfileView(data) {
            const { general, links, style, extras } = data;
            
            // 1. Render Tampilan & Font
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-gradient');
            document.body.classList.add(style.theme || 'theme-light');
            document.documentElement.style.setProperty('--font-family', style.font || "'Inter', sans-serif");
            if (style.bgImage) {
                dom.appContainer.style.backgroundImage = `url(${style.bgImage})`;
            } else {
                dom.appContainer.style.backgroundImage = 'none';
            }
            document.title = `${general.name} | BioLink`;

            // 2. Render Info General
            dom.profilePic.src = general.picUrl || 'https://placehold.co/128x128/e0e0e0/7f7f7f?text=Foto';
            dom.profileName.textContent = general.name || 'Nama Anda';
            dom.profileBio.textContent = general.bio || 'Bio Anda';

            // 3. Render Link
            dom.linksSection.innerHTML = '';
            if (links && links.length > 0) {
                links.forEach(link => {
                    const animationClass = link.animation !== 'none' ? `animate-${link.animation}` : '';
                    const linkEl = document.createElement('a');
                    linkEl.href = link.url;
                    linkEl.target = '_blank';
                    linkEl.rel = 'noopener noreferrer';
                    linkEl.dataset.linkId = link.id;
                    linkEl.className = `link-button w-full p-4 rounded-full shadow-lg flex items-center justify-center relative font-semibold text-center ${animationClass}`;
                    
                    linkEl.innerHTML = `
                        <i data-lucide="${link.icon || 'link'}" class="absolute left-5 w-5 h-5"></i>
                        <span>${link.title}</span>
                        ${isOwner ? `<span class="absolute right-5 text-xs font-normal text-gray-500 flex items-center gap-1"><i data-lucide="bar-chart-2" class="w-3 h-3"></i> ${link.clicks || 0}</span>` : ''}
                    `;
                    
                    linkEl.addEventListener('click', handleLinkClick);
                    dom.linksSection.appendChild(linkEl);
                });
            }

            // 4. Render Video Embed
            if (extras.videoUrl) {
                const embedUrl = convertToEmbedUrl(extras.videoUrl);
                if (embedUrl) {
                    dom.videoIframe.src = embedUrl;
                    dom.videoEmbedSection.classList.remove('hidden');
                } else {
                    dom.videoEmbedSection.classList.add('hidden');
                }
            } else {
                dom.videoEmbedSection.classList.add('hidden');
            }

            // 5. Render Email Signup
            dom.emailSignupSection.classList.toggle('hidden', !extras.emailSignup);
            
            // 6. Render Ikon Sosial
            dom.socialIconsSection.innerHTML = '';
            const socialMap = {
                instagram: 'instagram', twitter: 'twitter', facebook: 'facebook',
                linkedin: 'linkedin', github: 'github', tiktok: 'tiktok'
            };
            for (const [key, icon] of Object.entries(socialMap)) {
                if (extras.socials[key]) {
                    const socialEl = document.createElement('a');
                    socialEl.href = extras.socials[key];
                    socialEl.target = '_blank';
                    socialEl.rel = 'noopener noreferrer';
                    socialEl.title = key.charAt(0).toUpperCase() + key.slice(1);
                    socialEl.className = 'hover:scale-125 transition-transform';
                    socialEl.style.color = 'var(--text-color)';
                    socialEl.innerHTML = `<i data-lucide="${icon}" class="w-7 h-7"></i>`;
                    dom.socialIconsSection.appendChild(socialEl);
                }
            }

            // 7. Render Musik
            dom.audioPlayer.src = extras.songUrl || '';
            dom.songTitle.textContent = extras.songTitle || 'Musik Tidak Tersedia';
            dom.musicPopup.classList.toggle('hidden', !extras.songUrl);
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error("Lucide is not loaded yet.");
            }
        }
        
        /**
         * Render panel pengaturan (HANYA untuk pemilik)
         */
        function renderSettingsPanel(data) {
            const { general, links, style, extras } = data;
            
            // Tab Share
            const shareUrl = `${window.location.origin}${window.location.pathname}?profile=${viewedProfileId}`;
            dom.shareLinkInput.value = shareUrl;
            dom.qrcodeEl.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(dom.qrcodeEl, {
                    text: shareUrl,
                    width: 192,
                    height: 192,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            // Tab General
            $('#setting-name').value = general.name;
            $('#setting-bio').value = general.bio;
            $('#setting-pic-url').value = general.picUrl;
            
            // Tab Links
            const linksEditorList = $('#links-editor-list');
            linksEditorList.innerHTML = '';
            links.forEach((link, index) => {
                const editorEl = document.createElement('div');
                editorEl.className = 'p-4 border rounded-lg bg-gray-50';
                editorEl.dataset.linkId = link.id;
                editorEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-semibold text-gray-700">Link ${index + 1}</span>
                        <div>
                            <button class="btn-delete-link text-red-600 hover:text-red-800 p-1" title="Hapus Link">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <input type="text" class="setting-link-title w-full p-2 border rounded-lg" value="${link.title}" placeholder="Judul Link">
                        <input type="url" class="setting-link-url w-full p-2 border rounded-lg" value="${link.url}" placeholder="URL (https://...)">
                        <div class="flex gap-2">
                            <input type="text" class="setting-link-icon flex-1 w-full p-2 border rounded-lg" value="${link.icon}" placeholder="Ikon Lucide (cth: 'link')">
                            <select class="setting-link-animation flex-1 w-full p-2 border rounded-lg bg-white">
                                <option value="none" ${link.animation === 'none' ? 'selected' : ''}>Animasi: Diam</option>
                                <option value="pulse-slow" ${link.animation === 'pulse-slow' ? 'selected' : ''}>Animasi: Berdenyut</option>
                                <option value="shake" ${link.animation === 'shake' ? 'selected' : ''}>Animasi: Bergetar</option>
                                <option value="bounce-fast" ${link.animation === 'bounce-fast' ? 'selected' : ''}>Animasi: Memantul</option>
                            </select>
                        </div>
                    </div>
                `;
                linksEditorList.appendChild(editorEl);
            });
            
            // Tab Style
            $$('.theme-select-btn').forEach(btn => {
                btn.classList.toggle('ring-2', btn.dataset.theme === style.theme);
                btn.classList.toggle('ring-blue-500', btn.dataset.theme === style.theme);
            });
            $('#setting-bg-image').value = style.bgImage || '';
            $('#setting-font').value = style.font || "'Inter', sans-serif";
            
            // Tab Extras
            $('#setting-song-url').value = extras.songUrl || '';
            $('#setting-song-title').value = extras.songTitle || '';
            $('#setting-video-url').value = extras.videoUrl || '';
            $('#setting-email-signup').checked = extras.emailSignup || false;
            
            for (const key of ['instagram', 'twitter', 'facebook', 'linkedin', 'github', 'tiktok']) {
                $(`#social-${key}`).value = extras.socials[key] || '';
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * Setup semua event listener untuk panel pengaturan
         */
        function setupSettingsListeners() {
            // Toggle panel
            dom.toggleSettingsBtn.onclick = () => {
                dom.settingsPanel.classList.remove('translate-x-full');
                dom.settingsOverlay.classList.remove('hidden');
            };
            dom.closeSettingsBtn.onclick = dom.settingsOverlay.onclick = () => {
                dom.settingsPanel.classList.add('translate-x-full');
                dom.settingsOverlay.classList.add('hidden');
            };
            
            // Tab
            $$('.tab-btn').forEach(btn => {
                btn.onclick = (e) => {
                    $$('.tab-content').forEach(tab => tab.classList.add('hidden'));
                    $(`#${e.target.dataset.tab}`).classList.remove('hidden');
                    
                    $$('.tab-btn').forEach(b => b.classList.remove('text-blue-600', 'border-blue-600'));
                    e.target.classList.add('text-blue-600', 'border-blue-600');
                };
            });
            // Buka tab 'share' by default
            const defaultTab = $('.tab-btn[data-tab="tab-share"]');
            if(defaultTab) defaultTab.click();

            // Tombol Simpan
            $('#save-general-btn').onclick = saveGeneralSettings;
            $('#save-style-btn').onclick = saveStyleSettings;
            $('#save-extras-btn').onclick = saveExtrasSettings;

            // Tombol "Add Link"
            $('#add-link-btn').onclick = addLink;

            // Tombol "Copy Link"
            dom.copyLinkBtn.onclick = () => {
                dom.shareLinkInput.select();
                try {
                    document.execCommand('copy');
                    dom.copyLinkBtn.textContent = 'Disalin!';
                } catch (err) {
                    console.error('Gagal menyalin link:', err);
                    dom.copyLinkBtn.textContent = 'Gagal Salin';
                }
                setTimeout(() => dom.copyLinkBtn.textContent = 'Salin Link', 2000);
            };

            // Tombol Download Email
            $('#download-emails-btn').onclick = downloadEmails;

            // Event delegation untuk tombol di dalam list link (delete, update)
            $('#links-editor-list').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.btn-delete-link');
                if (deleteBtn) {
                    const linkEditor = deleteBtn.closest('[data-link-id]');
                    const linkId = linkEditor.dataset.linkId;
                    deleteLink(linkId);
                }
            });
            
            // Simpan link saat user selesai mengedit (on blur/change)
            $('#links-editor-list').addEventListener('change', (e) => {
                const input = e.target.closest('input, select');
                if (input) {
                    const linkEditor = input.closest('[data-link-id]');
                    const linkId = linkEditor.dataset.linkId;
                    updateLink(linkId, linkEditor);
                }
            });
            
            // Submit form email
            dom.emailForm.onsubmit = handleEmailSubmit;

            // Pemutar Musik
            dom.musicIconContainer.onclick = toggleMusic;

            // Tombol Go Home di Error Page
            dom.goHomeBtn.onclick = () => {
                window.location.search = ''; // Hapus query param & reload
            };
            
            // Listener untuk tombol tema
            $$('.theme-select-btn').forEach(btn => {
                btn.onclick = () => {
                    $$('.theme-select-btn').forEach(b => {
                        b.classList.remove('ring-2', 'ring-blue-500');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    btn.classList.add('ring-2', 'ring-blue-500');
                    btn.setAttribute('aria-pressed', 'true');
                };
            });

            console.log("Settings listeners attached.");
        }
        
        // --- 5. Fungsi Simpan & Aksi ---

        function showSaveNotification() {
            dom.saveNotification.classList.remove('hidden');
            setTimeout(() => {
                dom.saveNotification.classList.add('hidden');
            }, 3000);
        }

        async function saveGeneralSettings() {
            const data = {
                general: {
                    name: $('#setting-name').value,
                    bio: $('#setting-bio').value,
                    picUrl: $('#setting-pic-url').value
                }
            };
            try {
                await setDoc(profileDocRef, data, { merge: true });
                showSaveNotification();
            } catch (e) { console.error("Error saving general settings:", e); }
        }
        
        async function saveStyleSettings() {
            const selectedThemeBtn = $('.theme-select-btn.ring-blue-500');
            const data = {
                style: {
                    theme: selectedThemeBtn ? selectedThemeBtn.dataset.theme : 'theme-light',
                    bgImage: $('#setting-bg-image').value,
                    font: $('#setting-font').value
                }
            };
            try {
                await setDoc(profileDocRef, data, { merge: true });
                showSaveNotification();
            } catch (e) { console.error("Error saving style settings:", e); }
        }
        
        async function saveExtrasSettings() {
            const data = {
                extras: {
                    songUrl: $('#setting-song-url').value,
                    songTitle: $('#setting-song-title').value,
                    videoUrl: $('#setting-video-url').value,
                    emailSignup: $('#setting-email-signup').checked,
                    socials: {
                        instagram: $('#social-instagram').value,
                        twitter: $('#social-twitter').value,
                        facebook: $('#social-facebook').value,
                        linkedin: $('#social-linkedin').value,
                        github: $('#social-github').value,
                        tiktok: $('#social-tiktok').value,
                    }
                }
            };
            try {
                await setDoc(profileDocRef, data, { merge: true });
                showSaveNotification();
            } catch (e) { console.error("Error saving extras settings:", e); }
        }

        async function addLink() {
            const newLink = {
                id: crypto.randomUUID(),
                title: 'Link Baru',
                url: '#',
                icon: 'link',
                animation: 'none',
                clicks: 0
            };
            try {
                await updateDoc(profileDocRef, {
                    links: arrayUnion(newLink)
                });
                showSaveNotification();
            } catch (e) { console.error("Error adding new link:", e); }
        }
        
        async function updateLink(linkId, editorElement) {
            if (!profileData.links) profileData.links = [];
            
            const newLinks = profileData.links.map(link => {
                if (link.id === linkId) {
                    return {
                        ...link,
                        id: linkId,
                        title: editorElement.querySelector('.setting-link-title').value,
                        url: editorElement.querySelector('.setting-link-url').value,
                        icon: editorElement.querySelector('.setting-link-icon').value,
                        animation: editorElement.querySelector('.setting-link-animation').value
                    };
                }
                return link;
            });
            
            try {
                await updateDoc(profileDocRef, { links: newLinks });
            } catch (e) { console.error("Error updating link:", e); }
        }
        
        async function deleteLink(linkId) {
            if (window.prompt("Ketik 'HAPUS' untuk mengonfirmasi penghapusan link ini.") !== 'HAPUS') {
                 return;
            }
            
            const newLinks = profileData.links.filter(link => link.id !== linkId);
            try {
                await updateDoc(profileDocRef, { links: newLinks });
                showSaveNotification();
            } catch (e) { console.error("Error deleting link:", e); }
        }
        
        async function handleLinkClick(e) {
            if (isOwner) return; 
            
            e.preventDefault();
            
            const linkEl = e.currentTarget;
            const linkId = linkEl.dataset.linkId;
            const targetUrl = linkEl.href;
            
            if (!profileData.links) profileData.links = [];

            const newLinks = profileData.links.map(link => {
                if (link.id === linkId) {
                    return { ...link, clicks: (link.clicks || 0) + 1 };
                }
                return link;
            });

            try {
                await updateDoc(profileDocRef, { links: newLinks });
            } catch (e) {
                console.error("Error updating click count:", e);
            }
            
            window.open(targetUrl, '_blank');
        }

        async function handleEmailSubmit(e) {
            e.preventDefault();
            const email = dom.emailInput.value;
            if (!email) return;

            const emailsCollectionRef = collection(db, profileDocRef.path, 'emails');
            try {
                await addDoc(emailsCollectionRef, {
                    email: email,
                    collectedAt: serverTimestamp()
                });
                dom.emailSuccessMsg.classList.remove('hidden');
                dom.emailErrorMsg.classList.add('hidden');
                dom.emailInput.value = '';
                setTimeout(() => dom.emailSuccessMsg.classList.add('hidden'), 3000);
            } catch (e) {
                console.error("Error saving email:", e);
                dom.emailErrorMsg.classList.remove('hidden');
                dom.emailSuccessMsg.classList.add('hidden');
                setTimeout(() => dom.emailErrorMsg.classList.add('hidden'), 3000);
            }
        }
        
        async function downloadEmails() {
            const emailsCollectionRef = collection(db, profileDocRef.path, 'emails');
            try {
                const querySnapshot = await getDocs(emailsCollectionRef);
                let csvContent = "data:text/csv;charset=utf-t8,Email,CollectedAt\n";
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.collectedAt?.toDate ? data.collectedAt.toDate().toISOString() : 'N/A';
                    csvContent += `${data.email},${date}\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `emails_${viewedProfileId}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error("Error downloading emails:", e);
                alert("Gagal mengunduh daftar email.");
            }
        }

        function toggleMusic() {
            const isPlaying = !dom.audioPlayer.paused;
            if (isPlaying) {
                dom.audioPlayer.pause();
                dom.musicIconContainer.querySelector('[data-lucide="music"]').classList.remove('hidden');
                dom.musicIconContainer.querySelector('[data-lucide="pause"]').classList.add('hidden');
            } else {
                dom.audioPlayer.play().catch(e => console.error("Gagal memutar audio:", e));
                dom.musicIconContainer.querySelector('[data-lucide="music"]').classList.add('hidden');
                dom.musicIconContainer.querySelector('[data-lucide="pause"]').classList.remove('hidden');
            }
        }
        
        function onMusicEnded() {
            dom.musicIconContainer.querySelector('[data-lucide="music"]').classList.remove('hidden');
            dom.musicIconContainer.querySelector('[data-lucide="pause"]').classList.add('hidden');
        }

        // --- 6. Fungsi Helper ---

        function convertToEmbedUrl(url) {
            if (!url) return null;
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                }
                
                return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
            } catch (e) {
                console.warn("Invalid video URL:", url);
                return null;
            }
        }
        
        function loadCustomFonts() {
            const fonts = {
                'Poppins': 'https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap',
                'Lobster': 'https://fonts.googleapis.com/css2?family=Lobster&display=swap',
                'Roboto Slab': 'https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap',
                'JetBrains Mono': 'https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap',
                'Inter': 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'
            };

            for (const font in fonts) {
                const link = document.createElement('link');
                link.href = fonts[font];
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
        }

        // --- 7. Inisialisasi Aplikasi ---
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Loaded. Initializing app...");
            
            // 1. Definisikan variabel DOM
            dom = {
                loadingSpinner: $('#loading-spinner'),
                errorMessage: $('#error-message'),
                goHomeBtn: $('#go-home-btn'),
                mainContent: $('#main-content'),
                appContainer: $('#app-container'),
                profilePic: $('#profile-pic'),
                profileName: $('#profile-name'),
                profileBio: $('#profile-bio'),
                videoEmbedSection: $('#video-embed-section'),
                videoIframe: $('#video-iframe'),
                linksSection: $('#links-section'),
                emailSignupSection: $('#email-signup-section'),
                emailForm: $('#email-form'),
                emailInput: $('#email-input'),
                emailSuccessMsg: $('#email-success-msg'),
                emailErrorMsg: $('#email-error-msg'),
                socialIconsSection: $('#social-icons-section'),
                musicPopup: $('#music-player-popup'),
                musicIconContainer: $('#music-icon-container'),
                songTitle: $('#song-title'),
                audioPlayer: $('#audio-player'),
                ownerControls: $('#owner-controls'),
                settingsPanel: $('#settings-panel'),
                settingsOverlay: $('#settings-overlay'),
                toggleSettingsBtn: $('#toggle-settings-btn'),
                closeSettingsBtn: $('#close-settings-btn'),
                saveNotification: $('#save-notification'),
                shareLinkInput: $('#share-link-input'),
                copyLinkBtn: $('#copy-link-btn'),
                qrcodeContainer: $('#qrcode-container'),
                qrcodeEl: $('#qrcode'),
            };

            // 2. Muat Font
            loadCustomFonts();
            
            // 3. Setup Listener Musik
            dom.audioPlayer.onended = onMusicEnded;

            // 4. Setup Listener Pengaturan
            setupSettingsListeners();

            // 5. Mulai proses autentikasi
            // Cek jika firebase berhasil dimuat
            if (app) {
                handleAuth();
            } else {
                console.error("Firebase app is not initialized. Auth process stopped.");
            }

            // 6. Panggil createIcons()
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    } else {
                        console.error("Lucide failed to load.");
                    }
                }, 500);
            }
        });

    </script>

</body>
</html>

